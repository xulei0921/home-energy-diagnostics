# 家庭能耗体检与节能建议系统 - 开发规则

## 项目概述

这是一个基于Vue3 + FastAPI的家庭能耗管理系统，提供能耗数据录入、分析、异常检测和节能建议功能。系统采用前后端分离架构，后端使用Python FastAPI框架，前端使用Vue3 + Element Plus。

## 技术栈

### 后端技术栈
- **框架**: FastAPI (Python Web框架)
- **数据库**: SQLAlchemy ORM (支持多种数据库)
- **认证**: JWT (JSON Web Token)
- **依赖管理**: Python虚拟环境 (.venv)
- **异常检测**: 多种统计方法和机器学习算法

### 前端技术栈
- **框架**: Vue 3 (渐进式JavaScript框架)
- **UI组件库**: Element Plus
- **状态管理**: Pinia
- **路由**: Vue Router 4
- **构建工具**: Vite
- **图表库**: ECharts, Chart.js
- **HTTP客户端**: Axios

## 项目结构规则

### 后端目录结构
```
backend/
├── app/                    # 主要应用代码
│   ├── api/               # API路由层
│   ├── crud/              # 数据库CRUD操作
│   ├── services/          # 业务逻辑层
│   ├── models.py          # 数据库模型
│   ├── schemas.py         # Pydantic数据模型
│   ├── database.py        # 数据库连接配置
│   ├── dependencies.py    # 依赖注入
│   ├── utils.py           # 工具函数
│   └── main.py            # 应用入口
├── docs/                  # 文档
├── static/                # 静态文件
└── .env                   # 环境变量
```

### 前端目录结构
```
frontend/
├── src/
│   ├── api/              # API接口调用
│   ├── assets/           # 静态资源
│   ├── components/       # 可复用组件
│   ├── router/           # 路由配置
│   ├── stores/           # Pinia状态管理
│   ├── utils/            # 工具函数
│   ├── views/            # 页面组件
│   ├── App.vue           # 根组件
│   └── main.js           # 应用入口
├── public/               # 公共资源
└── vite.config.js        # Vite配置
```

## 开发规则

### 后端开发规则

#### 1. API设计规范
- 使用RESTful API设计原则
- 统一响应格式，包含code、message、data字段
- 使用HTTP状态码表示操作结果
- API前缀统一为 `/api/`
- 按功能模块分组，如 `/api/users`, `/api/bills`

#### 2. 数据库规范
- 使用SQLAlchemy ORM进行数据库操作
- 模型类继承自Base，使用declarative_base()
- 外键关系使用relationship定义
- 时间戳字段统一使用created_at和updated_at
- 软删除优于硬删除

#### 3. 认证授权
- 使用JWT进行用户认证
- 敏感操作需要身份验证
- 使用OAuth2PasswordBearer获取token
- Token有效期设置为合理时间

#### 4. 异常处理
- 使用FastAPI的HTTPException处理异常
- 提供清晰的错误信息
- 记录异常日志便于调试
- 区分客户端错误和服务器错误

#### 5. 智能分析服务
- 实现多种异常检测算法：
  - 统计阈值方法 (IQR, Z-score)
  - 季节性异常检测
  - 趋势异常检测
  - 综合异常检测
- 提供个性化的节能建议
- 支持多种能源类型：电力、燃气、水资源

### 前端开发规则

#### 1. 组件规范
- 使用Vue 3 Composition API
- 组件命名使用PascalCase
- 单文件组件结构：template > script > style
- 使用setup语法糖简化代码
- 组件props定义完整的类型和默认值

#### 2. 状态管理
- 使用Pinia进行状态管理
- Store按功能模块划分
- 使用composition函数封装逻辑
- 状态持久化使用pinia-plugin-persistedstate

#### 3. 路由规范
- 路由配置使用Vue Router 4
- 路由懒加载优化性能
- 路由守卫处理权限验证
- 路由命名使用kebab-case

#### 4. API调用规范
- 统一封装API请求方法
- 使用axios拦截器处理通用逻辑
- 错误统一处理和用户提示
- 请求loading状态管理

#### 5. UI/UX规范
- 使用Element Plus组件库
- 保持界面风格一致性
- 响应式设计适配不同设备
- 提供良好的用户反馈
- 表单验证完整且用户友好

## 代码质量规则

### 1. 代码风格
- 遵循PEP 8 (Python) 和 ESLint (JavaScript) 规范
- 使用有意义的变量和函数命名
- 添加必要的代码注释
- 保持函数单一职责原则

### 2. 安全性
- 输入数据验证和清理
- SQL注入防护
- XSS攻击防护
- 敏感信息加密存储
- HTTPS通信

### 3. 性能优化
- 数据库查询优化
- 前端资源懒加载
- 图片压缩和CDN使用
- API响应缓存
- 前端打包优化

### 4. 错误处理
- 完善的错误处理机制
- 用户友好的错误提示
- 日志记录和监控
- 异常情况的优雅降级

## 部署规则

### 1. 环境配置
- 使用环境变量管理配置
- 区分开发、测试、生产环境
- 敏感信息不提交到版本控制
- 数据库连接字符串加密

### 2. 构建部署
- 前端构建输出到dist目录
- 后端使用uvicorn/gunicorn部署
- 使用Docker容器化部署
- 配置Nginx反向代理

### 3. 监控运维
- 应用性能监控
- 错误日志收集
- 数据库备份策略
- 定期安全更新

## 文档规范

### 1. API文档
- 使用FastAPI自动生成的Swagger文档
- 详细的接口参数说明
- 响应示例和错误码说明
- 版本变更记录

### 2. 代码文档
- 函数和类的docstring
- 复杂的业务逻辑说明
- 配置文件说明
- 部署文档完整

### 3. 用户文档
- 系统使用手册
- 常见问题解答
- 功能特性介绍
- 更新日志

## 测试规则

### 1. 单元测试
- 核心业务逻辑测试
- API接口测试
- 数据库操作测试
- 异常处理测试

### 2. 集成测试
- 端到端功能测试
- 用户场景测试
- 性能压力测试
- 安全测试

## 版本管理

### 1. Git规范
- 使用语义化版本号
- 提交信息清晰描述变更
- 功能分支开发
- 定期合并主分支

### 2. 发布流程
- 版本发布计划
- 变更日志维护
- 向后兼容性考虑
- 回滚策略制定

## 持续改进

### 1. 代码审查
- 定期代码审查
- 性能瓶颈分析
- 安全漏洞扫描
- 技术债务管理

### 2. 用户反馈
- 收集用户反馈
- 功能需求评估
- 用户体验优化
- 问题快速响应

---

*本规则文档会根据项目发展持续更新和完善*