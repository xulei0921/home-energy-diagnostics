# 智能异常检测API使用文档

## 概述

智能异常检测系统替代了原有的固定30%阈值检测方式，使用多种统计方法和机器学习算法来识别能源消耗异常。该系统能够：

- 基于历史数据计算动态阈值
- 检测季节性能耗模式
- 识别趋势性异常
- 提供个性化的异常处理建议
- 按严重程度对异常进行分类

## 新增的异常检测算法

### 1. 统计阈值方法
- **四分位距方法 (IQR)**: 基于数据的四分位数计算异常阈值
- **Z-score方法**: 基于标准差的方法，适合正态分布数据
- **修正Z-score方法**: 使用中位数和MAD，对异常值更鲁棒

### 2. 季节性异常检测
- 分析相同季节的历史数据模式
- 识别季节性能耗变化异常
- 自动调整季节性基准

### 3. 趋势异常检测
- 使用线性回归分析能耗趋势
- 检测持续增长或下降的异常模式
- 评估趋势的统计显著性

### 4. 综合异常检测
- 结合多种检测方法的结果
- 基于置信度和检测方法数量进行综合判断
- 提供异常类型和严重程度分类

## API接口

### 1. 异常月份检测接口

**接口地址**: `GET /api/analysis/{bill_type}/anomaly-months`

**请求参数**:
- `bill_type` (路径参数): 能源类型
  - `electricity`: 电力
  - `gas`: 燃气
  - `water`: 水资源
- `months` (查询参数): 分析的月数，默认24个月

**响应示例**:
```json
[
  {
    "year": 2024,
    "month": 3,
    "usage": 450.5,
    "amount": 225.25,
    "avg_usage": 280.3,
    "deviation": 60.7,
    "anomaly_type": "trend",
    "severity": "high",
    "confidence": 0.85,
    "recommendations": [
      "检测到持续增长的能耗趋势，建议检查设备效率和使用习惯",
      "能耗增长趋势明显，建议立即进行设备能效评估"
    ]
  },
  {
    "year": 2023,
    "month": 12,
    "usage": 380.2,
    "amount": 190.1,
    "avg_usage": 290.8,
    "deviation": 30.7,
    "anomaly_type": "seasonal",
    "severity": "medium",
    "confidence": 0.72,
    "recommendations": [
      "检测到季节性能耗异常，请注意季节变化对能耗的影响",
      "建议调整季节性设备的使用策略"
    ]
  }
]
```

**使用示例**:
```bash
# 检测最近24个月的电力异常
GET /api/analysis/electricity/anomaly-months

# 检测最近12个月的燃气异常
GET /api/analysis/gas/anomaly-months?months=12

# 检测最近36个月的水资源异常
GET /api/analysis/water/anomaly-months?months=36
```

### 2. 现有接口的升级

原有的 `/api/analysis/energy-comparison` 接口已经升级为使用智能异常检测算法：

**响应变化**:
```json
{
  "current_usage": 320.5,
  "previous_usage": 245.8,
  "usage_yoy_rate": 15.2,
  "usage_mom_rate": 30.4,
  "amount_yoy_rate": 18.7,
  "amount_mom_rate": 32.1,
  "is_abnormal": true  // 现在使用智能检测算法，不再是简单的30%阈值
}
```

## 异常类型说明

### 异常类型 (anomaly_type)
- **`traditional`**: 基于传统阈值方法的异常
- **`statistical`**: 基于统计方法的异常
- **`seasonal`**: 季节性异常
- **`trend`**: 趋势性异常

### 严重程度 (severity)
- **`low`**: 轻微异常，建议关注
- **`medium`**: 中等异常，建议采取措施
- **`high`**: 严重异常，建议立即处理

### 置信度 (confidence)
- 范围: 0-1
- 0-0.5: 低置信度
- 0.5-0.7: 中等置信度
- 0.7-1.0: 高置信度

## 技术特点

### 1. 动态阈值
- 根据用户历史数据计算个性化阈值
- 适应不同用户的能耗模式
- 考虑季节性和趋势性变化

### 2. 多方法融合
- 综合多种检测方法的结果
- 提高检测准确性
- 减少误报和漏报

### 3. 智能建议
- 基于异常类型生成针对性建议
- 考虑用户的使用模式和习惯
- 提供可操作的改进方案

### 4. 鲁棒性
- 对异常值具有鲁棒性
- 处理数据缺失和噪声
- 适应不同的数据分布

## 使用建议

### 1. 数据要求
- 建议至少有6个月的历史数据
- 数据越完整，检测结果越准确
- 定期更新能耗数据以保持检测精度

### 2. 参数调优
- `months` 参数可根据需要调整
- 对于数据量大的用户，可以设置更大的时间窗口
- 新用户建议从较小的窗口开始

### 3. 结果解释
- 重点关注高置信度和高严重程度的异常
- 结合多个异常月份分析趋势
- 参考建议采取相应的节能措施

## 示例场景

### 场景1: 检测到设备故障
```
异常月份: 2024年2月
异常类型: statistical
严重程度: high
偏差: +85%
建议: "能耗增长85%超出正常范围，建议检查异常高耗能设备"
```

### 场景2: 季节性使用增加
```
异常月份: 2023年8月
异常类型: seasonal
严重程度: medium
偏差: +45%
建议: "检测到季节性能耗异常，请注意空调等季节性设备的使用"
```

### 场景3: 长期趋势增长
```
异常月份: 2024年1月
异常类型: trend
严重程度: high
置信度: 0.92
建议: "检测到持续增长的能耗趋势，建议进行全面的能源审计"
```

## 错误处理

### 常见错误码
- **400**: 参数错误（如months值无效）
- **401**: 用户未认证
- **404**: 用户数据不足
- **500**: 服务器内部错误

### 错误响应示例
```json
{
  "detail": "Insufficient data for anomaly detection. Please provide at least 3 months of energy consumption data."
}
```

## 性能考虑

- 接口响应时间通常在1-3秒内
- 大量历史数据（超过60个月）可能增加处理时间
- 系统会自动优化查询和计算性能

## 后续优化方向

1. **机器学习增强**: 集成更复杂的机器学习模型
2. **实时检测**: 支持实时异常检测和告警
3. **预测功能**: 基于历史数据预测未来异常
4. **个性化**: 更深度的用户个性化配置
5. **多维度分析**: 结合时间、设备、环境等多维度分析